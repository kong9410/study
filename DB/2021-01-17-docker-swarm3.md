---
title: 도커 스웜(Docker Swarm) #3
tags: docker
---

## 도커 스웜 네트워크

스웜 모드는 여러 개의 도커 엔진에 같은 컨테이너를 분산해서 할당하기 때문에 각 도커 데몬의 네트워크가 하나로 묶인 네트워크 풀이 필요하다. 어느 노드로 접근하더라도 해당 서비스의 컨테이너에 접근할 수 있게 라우팅이 필요하다.  이러한 네트워크 기능은 스웜 모드 자체적으로 지원하는 드라이버를 통해 사용할 수 있다.

도커 네트워크는 `docker network ls`를 통해 확인할 수 있다.

docker_gwbridge 네트워크는 스웜에서 오버레이 네트워크를 사용할 때 사용된다.

ingress 네트워크는 로드 밸런싱과 라우팅 메시에 사용된다.

### ingress 네트워크

ingress 네트워크는 스웜 클러스터를 생성하면 자동으로 등록되는 네트워크다. 스웜 모드를 사용할 때만 유효하다. 매니저 노드뿐 아니라 스웜 클러스테어 등록된 노드라면 전부 ingress 네트워크가 생성된다.

ingress 네트워크는 어떤 스웜 노드에 접근하더라도 서비스 내의 컨테이너에 접근할 수 있게 설정하는 라우팅 메시를 구성하고, 서비스 컨테이너에 대한 접근을 라운드 로빈 방식으로 분산하는 로드 밸런싱을 담당한다.

모든 스웜 모드가 서비스의 컨테이너가 외부로 노출되기 위해 ingress 네트워크를 사용해야 하는 것은 아니다. 호스트의 특정 포트를 사용하도록 설정해 ingress 네트워크를 사용하지 않고 호스트의 포트를 이용해 접근할 수 있다.

```shell
docker service create \
--publish mode=host,target=80,published=8080,protocol=tcp \
--name web \
nginx
```

그러나 ingress 네트워크를 사용하지 않고 위와 같이 서비스를 외부로 노출할 경우 어느 호스트에서 컨테이너가 생성될지 알 수 없어 포트 및 서비스 관리가 어렵다.

### 오버레이 네트워크

각 노드에 할당된 컨테이너 ip를 확인해보면은 ip주소가 다른 노드들과 차례대로 할당된 것을 확인할 수 있다. ingress 네트워크는 오버레이 네트워크를 사용한다. 오버레이 네트워크는 여러개의 도커 데몬을 하나의 네트워크 풀로 만드는 네트워크 가상화 기술의 하나로, 도커 오버레이 네트워크를 적용하면 여러 도커 데몬에 존재하는 컨테이너가 서로 통신할 수 있다. 스웜 노드에 할당된 컨테이너는 오버레이 네트워크의 서브넷에 해당하는 IP 대역을 할당받고 이 IP를 통해 서로 통신할 수 있다.

### docker_gwbridge 네트워크

오버레이 네트워크를 사용하지 않는 컨테이너는 기본적으로 존재하는 브리지 네트워크를 사용해 외부와 연결한다. 그외 모든 오버레이 네트워크는 docker_gwbridge를 사용한다. docker_gwbridge 네트워크는 외부로 나가는 통신 및 오버레이 네트워크의 트래픽 종단점(Vxlan Terminal End Point, VTEP) 역할을 담당한다. 컨테이너 내부의 네트워크 인터페이스 중 eth1과 연결된다.

### 사용자 정의 오버레이 네트워크

별도의 구성 없이 사용자 정의 오버레이 네트워크를 사용하고 생성할 수 있다.

```shell
docker network create \
--subnet 10.0.9.0/24 \
-d overlay \
myoverlay
```

네트워크 드라이버를 overlay로 `--subnet`으로 서브넷을 10.0.9.0으로 설정했다. 네트워크 이름은 myoverlay가 된다.

이렇게 만들어진 오버레이 네트워크의 scope는 swarm으로 설정되어 있고 이것은 스웜 클러스터에서만 사용할 수 있는 네트워크라는 의미이다. 스웜모드 외에는 일반적으로 사용할 수 없고 `docker run --net` 명령어로 스웜 모드의 네트워크를 사용할때 `--attachable`을 추가할 수 있다.

`docker service create`에 `--network` 옵션을 설정해 네트워크를 할당할 수 있다.

`docker service create`에서 `-p` 옵션을 사용하지 않으면 컨테이너는 ingress 네트워크를 사용하도록 설정되지 않는다. 마찬가지로 사용자 정의 오버레이 네트워크도 ingress 네트워크도 사용하지 않으면 docker_gwbridge 네트워크도 사용하지 않는다. 이때는 기본으로 사용하는 브리지 네트워크를 사용한다.

## 서비스 디스커버리

같은 컨테이너를 여러 개 만들어 사용할 때 쟁점이 되는 것중 하나가 새로 생성된 컨테이너의 발견과 없어진 컨테이너의 감지이다. 스웜 모드는 서비스 발견 기능을 자체적으로 지원한다. 서비스A와 B가 있고 서비스A는 B서비스의 컨테이너를 사용한다고 가정한다. 이때 서비스B에 새로운 컨테이너가 생성된다면 A는 B를 감지할 수 있을까라는 의문이 든다. 결론을 말하자면 서비스A의 입장에서는 서비스B에 컨테이너가 있는지 알필요가 없고 서비스B의 이름만 알면 된다.

이 때 서비스A는 각 서비스B 컨테이너의 모든 IP 주소를 알고있는 것이 아니다. 서비스B는 VIP를 가지고 있는 것이고 스웜 모드가 활성화된 도커 엔진의 내장 DNS 서버는 호스트의 IP로 변환하여 접근한다. 서비스A에서 서비스B로 접근할 때 서비스B의 IP로 접근하게 되며 컨테이너의 네트워크 네임스페이스 내부에서 실제 server 서비스의 컨테이너의 IP로 포워딩된다.

## 스웜 모드 볼륨

### volume 타입의 볼륨 생성

스웜 모드에서 도커 볼륨을 사용하는 서비스를 생성하려면 서비스를 생성할 때 `--mount` 옵션의 type값에 volume을 지정한다.

```shell
docker service create --name ubuntu \
--mount type=volume,source=myvol,target=/root \
ubuntu:14.04 \
ping docker.com
```

위 명령어는 볼륨을 사용하는 서비스를 생성한다. source는 사용할 볼륨, target은 컨테이너 내부에 마운트될 디렉터리 위치다. 도커 데몬에 이미 source에 해당하는 이름의 볼륨이 있으면 해당 볼륨을 사용하지만 없으면 새로 생성한다. source를 명시하지 않으면 임의의 이름을 가진 볼륨을 생성한다.

서비스 컨테이너에서 볼륨에 공유할 컨테이너의 디렉터리에 파일이 이미 존재하면 이 파일은 볼륨에 복사되고, 호스트에서 별도의 공간을 차지하게 된다. 서비스를 생성할 때 볼륨 옵션에 `volume-nocopy`를 추가하면 컨테이너의 파일들이 볼륨에 복사되지 않도록 설정할 수 있다.

```shell
docker service create --name ubuntu \
--mount type=volume,source=test,target=/etc/vim/,volume-nocopy \
ubuntu:14.04 \
ping docker.com

docker run -i -t --name test2 \
-v test:/root \
ubuntu:14.04

ls -la root/
```

위와 같이 volume-nocopy 옵션과 함께 서비스 볼륨을 생성한다면 test2의 /root 디렉토리 내용이 test 볼륨으로 복사되지 않는다.

### bind 타입의 볼륨 생성

바인드 타입은 호스트와 디렉터리를 공유할 때 사용된다. 볼륨 타입과 달리 공유될 호스트의 디렉터리를 설정해야 하므로 source 옵션을 반드시 명시해야 한다. type옵션 값은 bind로 설정한다.

```shell
docker service create --name ubuntu \
--mount type=bind,source=/root/host, target=/root/container \
ubuntu:14.04 \
ping docker.com
```

위 명령은 호스트의 /root/host 디렉터리를 서비스 컨테이너의 /root/container 디렉터리에 마운트하는 것이다.

### 스웜 모드 볼륨의 한계점

스웜 클러스터에서 볼륨을 사용하기란 까다롭다. 서비스를 할당받을 수 있는 모든 노드가 볼륨 데이터를 가지고있어야 하기 때문이다. 스웜 매니저의 스케줄러가 컨테이너를 할당할 때 어느 노드에 할당해도 서비스에 정의된 볼륨을 사용할 수 있어야 한다. 따라서 여러 개의 도커 데몬을 관리해야 하는 스웜 모드에서는 도커 볼륨, 또는 호스트와의 볼륨 사용이 적합하지 않는 기능일 수 있다.

이를 해결하기 위한 일반적인 방법은 어느 노드에서도 접근 가능한 퍼시스턴트 스토리지를 사용하는 것이다. 퍼시스턴트 스토리지는 호스트와 컨테이너와 별개로 외부에 존재해 네트워크로 마운트할 수 있는 스토리지다. 퍼시스턴트 스토리지를 마운트해 사용하면 노드에 볼륨을 생성하지 않아도 되고, 컨테이너가 어느 노드에 할당되든 컨테이너에 필요한 파일을 읽고 쓸수 있다. 도커가 자체제공하지는 않기 때문에 nfs, dfs등 서드파티를 별도로 구성해야 한다.

다른 방법으로 label을 노드에 붙여 서비스에 제한을 설정하는 방법이 있다. 노드에 라벨을 설정해 특정 서비스 동작에 필요한 볼륨이 존재하는 노드에만 할당할 수 있게 설정하는 것이다.

